rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for discovery)
      allow read: if isAuthenticated();
      
      // Allow user creation if:
      // 1. User is creating their own profile (normal case), OR
      // 2. User is authenticated and creating a document with matching uid (handles timing issues)
      allow create: if isOwner(userId) || 
                       (isAuthenticated() && 
                        request.resource.data.uid == request.auth.uid);
      
      // Allow updates if:
      // 1. User is updating their own profile, OR
      // 2. User is updating match-related fields (for mutual matching)
      allow update: if isOwner(userId) || 
                       (isAuthenticated() && 
                        request.resource.data.diff(resource.data).affectedKeys()
                          .hasOnly(['matches', 'matchCount', 'lastActive', 'isPremium', 'premiumActivatedAt', 'lastPaymentId', 'blockedBy']));
      
      // Only the user can delete their own profile
      allow delete: if isOwner(userId);
      
      // Likes subcollection - tracks who this user liked
      match /likes/{targetUserId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // Received likes subcollection - tracks who liked this user
      match /receivedLikes/{senderId} {
        allow read: if isOwner(userId);
        allow write: if isAuthenticated(); // Others can write when they like
      }
      
      // Super likes subcollection
      match /superLikes/{targetUserId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // Received super likes subcollection
      match /receivedSuperLikes/{senderId} {
        allow read: if isOwner(userId);
        allow write: if isAuthenticated();
      }
      
      // Passes subcollection - tracks who this user passed on
      match /passes/{targetUserId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // Matches collection
    match /matches/{matchId} {
      // Helper to check if user is participant in the match
      function isMatchParticipant() {
        return request.auth.uid in resource.data.users;
      }
      
      // Helper to check if user will be participant (for creates)
      function willBeParticipant() {
        return request.auth.uid in request.resource.data.users;
      }
      
      // Allow reading if:
      // 1. Document exists and user is a participant, OR
      // 2. User is authenticated (to check if match exists before creating)
      allow read: if isAuthenticated();
      
      // Allow creating if user will be a participant in the new match
      allow create: if isAuthenticated() && willBeParticipant();
      
      // Allow updating/deleting only if user is a participant
      allow update: if isAuthenticated() && isMatchParticipant();
      allow delete: if isAuthenticated() && isMatchParticipant();
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Extract user IDs from chatId (format: userId1_userId2)
      function getChatUsers() {
        return chatId.split('_');
      }
      
      // Check if current user is part of this chat
      function isParticipant() {
        return isAuthenticated() && 
               request.auth.uid in getChatUsers();
      }
      
      allow read: if isParticipant();
      allow write: if isParticipant();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isParticipant();
        allow create: if isParticipant();
        allow update: if false; // Messages cannot be edited
        allow delete: if false; // Messages cannot be deleted
      }
    }
    
    // Swipes collection (centralized tracking)
    match /swipes/{swipeId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId || 
                      request.auth.uid == resource.data.targetUserId);
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId;
      allow update: if false; // Swipes cannot be modified
      allow delete: if isOwner(resource.data.userId); // Only swiper can undo
    }
    
    // Payment orders collection
    match /payment_orders/{orderId} {
      // Users can read their own payment orders
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      // Users can create payment orders for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Users can update their own payment orders (for status updates)
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      // No deletion allowed
      allow delete: if false;
    }
    // ========================================
    // SWIPE LIMIT SYSTEM
    // ========================================
    
    // Swipe stats - Users can read/write their own stats
    match /swipe_stats/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // Don't allow deletion
    }
    
    // ========================================
    // SAFETY & REPORTING SYSTEM
    // ========================================
    
    // User reports - Users can create reports, only view their own
    match /reports/{reportId} {
      allow read: if isAuthenticated() && resource.data.reporterId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.reporterId == request.auth.uid;
      allow update: if false; // Reports cannot be modified
      allow delete: if false; // Reports cannot be deleted
    }
    
    // Blocks collection - Users can manage their own blocks
    match /blocks/{blockId} {
      allow read: if isAuthenticated() && 
                     (resource.data.blockerId == request.auth.uid || 
                      resource.data.blockedUserId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.blockerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.blockerId == request.auth.uid;
      allow update: if false;
    }
    
    // ========================================
    // REWARDS SYSTEM
    // ========================================
    
    match /rewards_stats/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    match /reward_incentives/{incentiveId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only backend can create incentives
    }
    
    match /reward_history/{historyId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    match /daily_conversations/{userId}/{document=**} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ========================================
    // NOTIFICATIONS SYSTEM
    // ========================================
    
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ========================================
    // PAYMENT & SUBSCRIPTION SYSTEM
    // ========================================
    
    match /payment_transactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    match /subscriptions/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // ========================================
    // SPOTLIGHT SYSTEM
    // ========================================
    
    match /spotlight_bookings/{bookingId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    match /spotlight_transactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ========================================
    // VERIFICATION SYSTEM
    // ========================================
    
    match /verification_requests/{requestId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    match /verification_photos/{photoId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ========================================
    // LEADERBOARD SYSTEM (Public Read)
    // ========================================
    
    match /leaderboard/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false; // Only backend updates leaderboard
    }
    
    match /monthly_leaderboard/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ========================================
    // ADMIN COLLECTIONS (Restricted)
    // ========================================
    
    match /admin_logs/{logId} {
      allow read, write: if false; // Only backend/admin SDK
    }
    
    match /admin_sessions/{sessionId} {
      allow read, write: if false; // Only backend/admin SDK
    }
    
    match /system_stats/{statId} {
      allow read: if isAuthenticated(); // Users can view stats
      allow write: if false; // Only backend updates
    }
    
    // Block any other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
