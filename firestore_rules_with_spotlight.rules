rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for discovery)
      allow read: if isAuthenticated();
      
      // Only the user can create their own profile
      allow create: if isOwner(userId);
      
      // User can update their own profile (simplified - no field restrictions)
      allow update: if isOwner(userId);
      
      // Only the user can delete their own profile
      allow delete: if isOwner(userId);
      
      // Likes subcollection - tracks who this user liked
      match /likes/{targetUserId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // Received likes subcollection - tracks who liked this user
      match /receivedLikes/{senderId} {
        allow read: if isOwner(userId);
        allow write: if isAuthenticated(); // Others can write when they like
      }
      
      // Super likes subcollection
      match /superLikes/{targetUserId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
      
      // Received super likes subcollection
      match /receivedSuperLikes/{senderId} {
        allow read: if isOwner(userId);
        allow write: if isAuthenticated();
      }
      
      // Passes subcollection - tracks who this user passed on
      match /passes/{targetUserId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // Matches collection
    match /matches/{matchId} {
      // Helper to check if user is participant in the match
      function isMatchParticipant() {
        return request.auth.uid in resource.data.users;
      }
      
      // Helper to check if user will be participant (for creates)
      function willBeParticipant() {
        return request.auth.uid in request.resource.data.users;
      }
      
      // Allow reading if authenticated
      allow read: if isAuthenticated();
      
      // Allow creating if user will be a participant in the new match
      allow create: if isAuthenticated() && willBeParticipant();
      
      // Allow updating/deleting only if user is a participant
      allow update: if isAuthenticated() && isMatchParticipant();
      allow delete: if isAuthenticated() && isMatchParticipant();
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Extract user IDs from chatId (format: userId1_userId2)
      function getChatUsers() {
        return chatId.split('_');
      }
      
      // Check if current user is part of this chat
      function isParticipant() {
        return isAuthenticated() && 
               request.auth.uid in getChatUsers();
      }
      
      allow read: if isParticipant();
      allow write: if isParticipant();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isParticipant();
        allow create: if isParticipant();
        allow update: if false; // Messages cannot be edited
        allow delete: if false; // Messages cannot be deleted
      }
    }
    
    // Swipes collection (centralized tracking)
    match /swipes/{swipeId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId || 
                      request.auth.uid == resource.data.targetUserId);
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId;
      allow update: if false; // Swipes cannot be modified
      allow delete: if isOwner(resource.data.userId); // Only swiper can undo
    }
    
    // ========================================
    // REWARDS SYSTEM
    // ========================================
    
    // Rewards stats - Users can read/write their own stats
    match /rewards_stats/{userId} {
      allow read: if isAuthenticated(); // Anyone can read for leaderboard
      allow write: if isOwner(userId); // Only user can update their own stats
    }
    
    // Reward incentives - All users can read active rewards
    match /reward_incentives/{incentiveId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins via console
    }
    
    // Reward history - Users can read their own reward history
    match /reward_history/{historyId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only system can write
    }
    
    // Daily conversations tracking - Users can read/write their own
    match /daily_conversations/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only system can write
    }
    
    // ========================================
    // PAYMENT SYSTEM
    // ========================================
    
    // Payment orders - Users can manage their own payment orders
    match /payment_orders/{orderId} {
      // Users can read their own payment orders
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can create payment orders
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Users can update their own payment orders
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // Users cannot delete payment records
      allow delete: if false;
    }
    
    // Payment transactions - Read-only for users
    match /payment_transactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only backend/cloud functions can write
    }
    
    // Subscription status - Users can read their own subscription
    match /subscriptions/{userId} {
      allow read: if isOwner(userId);
      allow write: if false; // Only backend updates subscription status
    }
    
    // ========================================
    // SPOTLIGHT SYSTEM
    // ========================================
    
    // Spotlight bookings - Users can manage their own bookings
    match /spotlight_bookings/{bookingId} {
      // Users can read their own bookings, or anyone can read active bookings (for discovery)
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.status == 'active');
      
      // Users can create bookings for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      // Users can update their own bookings (for cancellation)
      // System can update for activation/completion
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // Block any other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
